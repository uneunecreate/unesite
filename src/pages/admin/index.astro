---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Admin Dashboard">
  <div class="admin-container">
    <div class="admin-header">
      <h1>Admin Dashboard</h1>
      <button id="logoutBtn" class="btn-secondary">Logout</button>
    </div>

    <div class="admin-tabs">
      <button class="tab-button active" data-tab="about">About</button>
      <button class="tab-button" data-tab="news">News</button>
      <button class="tab-button" data-tab="gallery">Gallery</button>
    </div>

    <div id="about" class="tab-content active">
      <h2>About Page Content</h2>
      <form id="aboutForm">
        <div class="form-group">
          <label for="aboutTitle">Title:</label>
          <input type="text" id="aboutTitle" placeholder="About title">
        </div>
        <div class="form-group">
          <label for="aboutDescription">Description:</label>
          <textarea id="aboutDescription" placeholder="About description" rows="6"></textarea>
        </div>
        <div class="form-group">
          <label for="aboutImage">Image URL:</label>
          <input type="url" id="aboutImage" placeholder="https://example.com/image.jpg">
        </div>
        <button type="submit" class="btn-primary">Save</button>
      </form>
      <p id="aboutMessage"></p>
    </div>

    <div id="news" class="tab-content">
      <h2>News Articles</h2>
      <button id="addNewsBtn" class="btn-primary">Add New Article</button>
      <div id="newsList"></div>
    </div>

    <div id="gallery" class="tab-content">
      <h2>Gallery Items</h2>
      <button id="addGalleryBtn" class="btn-primary">Add Gallery Item</button>
      <div id="galleryList"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
    const SUPABASE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

    async function fetchWithAuth(endpoint, options = {}) {
      const session = JSON.parse(localStorage.getItem('adminSession'));
      if (!session) {
        window.location.href = '/admin/login';
        return;
      }

      const response = await fetch(`${SUPABASE_URL}/rest/v1${endpoint}`, {
        ...options,
        headers: {
          ...options.headers,
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.status === 401) {
        localStorage.removeItem('adminSession');
        window.location.href = '/admin/login';
        return;
      }

      return response;
    }

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        button.classList.add('active');
        document.getElementById(button.dataset.tab).classList.add('active');
      });
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('adminSession');
      window.location.href = '/admin/login';
    });

    // Load About
    async function loadAbout() {
      const response = await fetchWithAuth('/about?select=*&limit=1');
      const data = await response.json();
      if (data.length > 0) {
        document.getElementById('aboutTitle').value = data[0].title;
        document.getElementById('aboutDescription').value = data[0].description;
        document.getElementById('aboutImage').value = data[0].image_url;
      }
    }

    // Save About
    document.getElementById('aboutForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('aboutTitle').value;
      const description = document.getElementById('aboutDescription').value;
      const image_url = document.getElementById('aboutImage').value;

      const response = await fetchWithAuth('/about', {
        method: 'PATCH',
        body: JSON.stringify({ title, description, image_url })
      });

      if (response.ok) {
        document.getElementById('aboutMessage').textContent = 'Saved successfully!';
        document.getElementById('aboutMessage').style.color = 'green';
      }
    });

    // Load News
    async function loadNews() {
      const response = await fetchWithAuth('/news?select=*&order=created_at.desc');
      const data = await response.json();
      const newsList = document.getElementById('newsList');
      newsList.innerHTML = data.map(article => `
        <div class="list-item">
          <div class="list-item-content">
            <h3>${article.title}</h3>
            <p>${article.content.substring(0, 100)}...</p>
            <small>Published: ${article.published ? 'Yes' : 'No'}</small>
          </div>
          <div class="list-item-actions">
            <button class="btn-small" onclick="editNews('${article.id}')">Edit</button>
            <button class="btn-small btn-danger" onclick="deleteNews('${article.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Load Gallery
    async function loadGallery() {
      const response = await fetchWithAuth('/gallery?select=*&order=sort_order');
      const data = await response.json();
      const galleryList = document.getElementById('galleryList');
      galleryList.innerHTML = data.map(item => `
        <div class="list-item">
          <div class="list-item-content">
            <h3>${item.title}</h3>
            <p>${item.description}</p>
            <small>Order: ${item.sort_order}</small>
          </div>
          <div class="list-item-actions">
            <button class="btn-small" onclick="editGallery('${item.id}')">Edit</button>
            <button class="btn-small btn-danger" onclick="deleteGallery('${item.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    window.deleteNews = async (id) => {
      if (confirm('Delete this article?')) {
        await fetchWithAuth(`/news?id=eq.${id}`, { method: 'DELETE' });
        loadNews();
      }
    };

    window.deleteGallery = async (id) => {
      if (confirm('Delete this item?')) {
        await fetchWithAuth(`/gallery?id=eq.${id}`, { method: 'DELETE' });
        loadGallery();
      }
    };

    window.editNews = (id) => {
      alert('Edit feature coming soon');
    };

    window.editGallery = (id) => {
      alert('Edit feature coming soon');
    };

    document.getElementById('addNewsBtn').addEventListener('click', () => {
      alert('Add news feature coming soon');
    });

    document.getElementById('addGalleryBtn').addEventListener('click', () => {
      alert('Add gallery feature coming soon');
    });

    // Initialize
    window.addEventListener('load', () => {
      const session = localStorage.getItem('adminSession');
      if (!session) {
        window.location.href = '/admin/login';
        return;
      }
      loadAbout();
      loadNews();
      loadGallery();
    });
  </script>

  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      min-height: 100vh;
      background: #f5f5f5;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #ddd;
    }

    .admin-header h1 {
      margin: 0;
      color: #333;
    }

    .admin-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid #ddd;
    }

    .tab-button {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 1rem;
      color: #666;
      transition: all 0.2s;
    }

    .tab-button:hover {
      color: #333;
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: #333;
      font-weight: 500;
    }

    input, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
      box-sizing: border-box;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-primary {
      padding: 0.75rem 1.5rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      padding: 0.75rem 1.5rem;
      background: #999;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
    }

    .btn-secondary:hover {
      background: #777;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 0.5rem;
    }

    .btn-small:hover {
      background: #5568d3;
    }

    .btn-danger {
      background: #e74c3c;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border: 1px solid #eee;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .list-item-content h3 {
      margin: 0 0 0.5rem 0;
      color: #333;
    }

    .list-item-content p {
      margin: 0.5rem 0;
      color: #666;
      font-size: 0.9rem;
    }

    .list-item-content small {
      color: #999;
    }

    .list-item-actions {
      display: flex;
      gap: 0.5rem;
    }

    #aboutMessage {
      margin-top: 1rem;
      min-height: 1.5rem;
    }
  </style>
</Layout>